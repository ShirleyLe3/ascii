const t=String.fromCharCode,n=t=>t.charCodeAt(0),r=Object.assign,e=r,i=r=>{const[e,i]=[...r].map(n),o=[...Array(i-e).keys()].map(t=>e+t);return t(...o,i)},o=i(" ^")+i("`~"),s=o+i("¡§")+"®°±©«¬´µ·»¿×÷",a={__proto__:null,ascii:o,extended:s,extra:s+i("‘•")+"‹›∙√∞"},c=CanvasRenderingContext2D,u=(l="canvas",(...t)=>e(document.createElement(l),...t));var l;const f=(t,n)=>r([t,n,t/n],{width:t,height:n,ratio:t/n}),h=t=>t instanceof c?t.canvas:t,d=t=>{if(t instanceof HTMLVideoElement)return f(t.videoWidth,t.videoHeight);if(t instanceof HTMLImageElement)return f(t.naturalWidth,t.naturalHeight);const n=h(t);return f(n.width,n.height)},v=t=>{const n=u().getContext("2d");return(r,i)=>{var o;return e(n.canvas,{width:r,height:i}),null===(o=t)||void 0===o||o(n),n}},{abs:m,clz32:p,floor:g,max:x,random:_,round:y}=Math,P=(t,n,r)=>.2126*t+.7152*n+.0722*r,M=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,w=t=>1<<x(0,31-p(t)),$=()=>{const t=(()=>{const t=v();return(n,r,e)=>{const i=t(r,e);return i.drawImage(h(n),0,0,r,e),i}})(),n=(()=>{const t=v();return(n,r,e,i=0,o=0)=>{const s=t(r,e);return s.drawImage(h(n),i,o,r,e,0,0,r,e),s}})();return(r,e,i)=>{const[o,s]=d(r);let a=e*w(o/e-1),c=i*w(s/i-1);const u=t(r,a,c);if(e===a&&i===c)return u;for(let t,n;t=a>e,n=c>i,t||n;)u.drawImage(u.canvas,0,0,a,c,0,0,a>>=+t,c>>=+n);return n(u,e,i)}},S=v(),b=$();class C extends Float32Array{constructor(t,n){super(t*n),this.width=t,this.height=n}static fromCharCode(n,r){const{fontWidth:e,fontHeight:i,fontFamily:o,fontBlur:s,fontGamma:a}=r,{fontBase:c,lutWidth:u,lutHeight:l,lutPadding:f,lutGamma:h}=r,d=2*f+u,v=2*f+l,m=y(d/u*e),p=y(v/l*i),g=S(m,p),x=t(n);g.fillStyle="#00f",g.fillRect(0,0,m,p),g.translate(m/2,p/2),g.fillStyle="#000",g.fillRect(-e/2,-i/2,e,i),g.translate(0,i*(.5-c)),g.fillStyle="#fff",g.textAlign="center",g.font=`${i}px ${o}`;for(let t=0,n=1,r=1;s>t;[n,r]=[r,r+n])g.filter=`blur(${r}px)`,g.globalAlpha=(++t/s)**a,g.fillText(x,0,0);const _=new C(u,l),P=b(g,d,v).getImageData(f,f,u,l).data;for(let t=0;_.length>t;t++)_[t]=M(P[t<<2]/255)**h;return _}static combine(t){const n=t[0].length,r=t.length,e=new C(n,r);for(let i=0;r>i;i++)e.set(t[i],i*n);return e}normalize(t,n){for(let r=this.length;r--;)this[r]=(this[r]-t)/(n-t)}compare(t){let n=0;for(let r=this.length;r--;)n+=m(this[r]-t[r]);return n}}const L={charSet:o,fontFamily:"monospace",fontBase:.25,fontWidth:40,fontHeight:70,fontBlur:9,fontGamma:1,lutWidth:5,lutHeight:7,lutPadding:1,lutMin:0,lutMax:1,lutGamma:1,gamma:1,signal:1,noise:0},U=t=>{const n=v(n=>n.font=`1em ${t}`)(0,0),r=n.measureText(" ");return t=>n.measureText(t).width===r.width};class B{constructor(t){this.t=(()=>{const t=$();return(n,r,e)=>{const[i,o]=d(n);return r!==i||e!==o?t(n,r,e):n}})(),this.settings={...L,...t},this.i=this.o(),this.s=this.u()}o(){const{charSet:t,fontFamily:r}=this.settings,e=[...t].filter(U(r)).map(n);return Int32Array.from(e)}u(){const{i:t,settings:n}=this,{lutMin:r,lutMax:e}=n,i=Array.from(t,t=>C.fromCharCode(t,n)),o=i.reduce((t,n)=>x(t,...n),0);for(const t of i)t.normalize(r*o,e*o);return i}render(t,n,r){return[...this.l(t,g(n),g(r))].join("\n")}}class G extends B{constructor(){super(...arguments),this.h=(()=>{const t=v();return n=>{const[r,e]=d(n),i=t(r,e);return i.drawImage(h(n),0,0),i}})()}*l(n,r,e){const{settings:i,i:o,s,t:a,h:c}=this,{lutWidth:u,lutHeight:l,gamma:f,signal:h,noise:d}=i,v=u*r,m=l*e,p=c(a(n,v,m)).getImageData(0,0,v,m).data,g=new C(u,l);for(let n=0;m>n;n+=l){const r=[];for(let t=0;v>t;t+=u){let e=0,i=1/0;for(let r=0;l>r;r++)for(let i=0;u>i;i++){let o=t+i+(n+r)*v<<2;const s=M(p[o++]/255),a=M(p[o++]/255),c=M(p[o++]/255),u=P(s,a,c)**f,l=_()-.5;g[e++]=h*u+d*l}for(let t=s.length;t--;){const n=s[t].compare(g);i>n&&(i=n,e=t)}r.push(o[e])}yield t(...r)}}}const A=(t,n,r)=>e=>(e&&(r(n),e(t,n),r(null)),n),z=(t,n)=>r=>t.getUniformLocation(n,r),E=(t,n=3553)=>{const r=t.createTexture();return A(t,r,r=>t.bindTexture(n,r))},F=(t,n,r)=>{const e=`#version 300 es\n${r}`,i=t.createShader(n);if(t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,35713)){const n=t.getShaderInfoLog(i);throw Error(`Shader error:\n${n}\n${((t,n=1)=>t.replace(/^/gm,()=>`${n++}: `.padStart(5,"0")))(e)}\n`)}return i},T=(t,n,r)=>{const e=t.createProgram();if(t.attachShader(e,n),t.attachShader(e,r),t.linkProgram(e),!t.getProgramParameter(e,35714)){const n=t.getProgramInfoLog(e);throw Error(`Program error: ${n}`)}return e},H="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = .5 + .5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",O="#define MAP3(fn, v3) vec3(fn(v3.x), fn(v3.y), fn(v3.z))\n#define RGB(v1) mix(v1/12.92, pow((v1+.055)/1.055, 2.4), step(.04045, v1))\n#define LUM(v3) dot(MAP3(RGB, v3), vec3(.2126, .7152, .0722))\nprecision highp float;\nuniform sampler2D uSrc;\nuniform float uGamma;\nuniform float uSignal;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout float vOutput;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 1031.);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec4 t = texture(uSrc, vPosition);\nfloat s = pow(LUM(t), uGamma);\nfloat n = hash13(vec3(vPosition, uRandom)) - 0.5;\nvOutput = uSignal*s + uNoise*n;\n}\n",k="#define U ${ width }\n#define V ${ height }\n#define X ${ width * height }\n#define Y ${ chars }\n#define Block float[X]\n#define CharCode int\nprecision highp float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nuniform int uCharMap[Y];\nin vec2 vPosition;\nout int vOutput;\nBlock read() {\nvec2 center = vec2(textureSize(uSrc, 0))*vPosition;\nivec2 topLeft = ivec2(center) - ivec2(U, V)/2;\nBlock src;\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, topLeft + ivec2(u, v), 0).r;\nreturn src;\n}\nCharCode closest(Block src) {\nstruct Pair { float diff; int idx; };\nPair closest = Pair(exp(1000.), 0);\nfor (int y = 0; y < Y; y++) {\nfloat diff = 0.;\nfor (int x = 0; x < X; x++)\ndiff += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (diff < closest.diff)\nclosest = Pair(diff, y);\n}\nreturn uCharMap[closest.idx];\n}\nvoid main() {\nvOutput = closest(read());\n}\n",R=t=>{t.texParameteri(3553,10241,9728),t.texParameteri(3553,10240,9728)};class W extends B{constructor(t){super(t),this.v=((t,...n)=>{const r=u().getContext("webgl2",t);if(!r)throw Error("WebGL2 is unavailable");for(const t of n)if(!r.getExtension(t))throw Error(`"${t}" extension is unavailable`);return r})({},"EXT_color_buffer_float"),this.m=((t,n=36160)=>{const r=t.createFramebuffer();return A(t,r,r=>t.bindFramebuffer(n,r))})(this.v)(),this.p=E(this.v)(R),this.g=E(this.v)(R),this._=E(this.v)(R),this.P=C.combine(this.s),this.M=new Int32Array;const n=F(this.v,35633,H),r=F(this.v,35632,O),e=F(this.v,35632,((t,n={},r="$")=>Function(`{${Object.keys(n)}}`,r,`return \`${t}\``)(n,n))(k,{chars:this.i.length,width:this.settings.lutWidth,height:this.settings.lutHeight}));var i;this.$=T(this.v,n,r),this.S=T(this.v,n,e),((t,n=34962)=>{const r=t.createBuffer();return A(t,r,r=>t.bindBuffer(n,r))})(this.v)((i=0,t=>{const n=Float32Array.of(1,1,-1,1,1,-1,-1,-1);t.bufferData(34962,n,35044),t.vertexAttribPointer(i,2,5126,!1,0,0),t.enableVertexAttribArray(i)}))}*l(n,r,e){const{settings:i,i:o,P:s,v:a,t:c}=this,{$:u,S:l,m:f,p:d,g:v,_:m}=this,p=i.lutWidth*r,g=i.lutHeight*e,x=h(c(n,p,g)),y=z(a,u),P=z(a,l),M=r*e;this.M.length!==M&&(this.M=new Int32Array(M)),a.bindFramebuffer(36160,f),a.activeTexture(33986),a.bindTexture(3553,d),a.texImage2D(3553,0,33326,s.width,s.height,0,6403,5126,s),a.activeTexture(33985),a.bindTexture(3553,v),a.texImage2D(3553,0,6408,6408,5121,x),a.activeTexture(33984),a.bindTexture(3553,m),a.texImage2D(3553,0,33326,p,g,0,6403,5126,null),a.framebufferTexture2D(36160,36064,3553,m,0),a.useProgram(u),a.uniform1i(y("uSrc"),1),a.uniform1f(y("uGamma"),i.gamma),a.uniform1f(y("uSignal"),i.signal),a.uniform1f(y("uNoise"),i.noise),a.uniform1f(y("uRandom"),_()),a.viewport(0,0,p,g),a.drawArrays(5,0,4),a.activeTexture(33985),a.bindTexture(3553,m),a.activeTexture(33984),a.bindTexture(3553,v),a.texImage2D(3553,0,33333,p,g,0,36244,5124,null),a.framebufferTexture2D(36160,36064,3553,v,0),a.useProgram(l),a.uniform1i(P("uSrc"),1),a.uniform1i(P("uLUT"),2),a.uniform1iv(P("uCharMap"),o),a.viewport(0,0,r,e),a.drawArrays(5,0,4),a.readPixels(0,0,r,e,36244,5124,this.M),a.bindFramebuffer(36160,null);for(let n=0;M>n;)yield t(...this.M.subarray(n,n+=r))}}export{G as CPURenderer,c as Context,W as GPURenderer,C as LUT,B as Renderer,a as charSets,L as defaults,U as monospaced};
//# sourceMappingURL=bundle.esm.min.js.map
