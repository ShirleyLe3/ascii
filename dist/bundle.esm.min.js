const t=String.fromCharCode,n=t=>t.charCodeAt(0),r=r=>{const[e,o]=[...r].map(n),i=[...Array(o-e).keys()].map(t=>e+t);return t(...i,o)},e=r(" ^")+r("`~"),o=e+r("¡§")+"®°±©«¬´µ·»¿×÷",i={__proto__:null,ascii:e,extended:o,extra:o+r("‘•")+"‹›∙√∞"},s=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,{abs:a,clz32:u,floor:c,max:h,random:l,round:f}=Math,v=Object.assign,m=v,d=t=>(...n)=>m(document.createElement(t),...n),g=(t,n)=>v([t,n,t/n],{width:t,height:n,ratio:t/n}),p=t=>t instanceof CanvasRenderingContext2D?t.canvas:t,x=t=>{const n=y()(_(t));return n.drawImage(p(t),0,0),n},_=t=>{if(t instanceof HTMLVideoElement)return g(t.videoWidth,t.videoHeight);if(t instanceof HTMLImageElement)return g(t.naturalWidth,t.naturalHeight);const n=p(t);return g(n.width,n.height)},y=t=>{const n=d("canvas")(),r=n.getContext("2d");return e=>{var o;return m(n,e),null===(o=t)||void 0===o||o(r),r}},w=t=>1<<h(0,31-u(t)),M=()=>{const t=(()=>{const t=y();return(n,r,e)=>{const o=t({width:r,height:e});return o.drawImage(p(n),0,0,r,e),o}})(),n=(()=>{const t=y();return(n,r,e,o,i)=>{const s=t({width:o,height:i});return s.drawImage(p(n),r,e,o,i,0,0,o,i),s}})();return(r,e,o)=>{const[i,s]=_(r);let a=e*w(i/e-1),u=o*w(s/o-1);const c=t(r,a,u);if(e===a&&o===u)return c;for(let t,n;t=a>e,n=u>o,t||n;)c.drawImage(c.canvas,0,0,a,u,0,0,a>>=+t,u>>=+n);return n(c,0,0,e,o)}},b=y(),$=M();class C extends Float32Array{constructor(t,n){super(t*n),this.width=t,this.height=n}static fromCharCode(n,r){const{fontWidth:e,fontHeight:o,fontFamily:i,fontBlur:a,fontGamma:u}=r,{fontBase:c,lutWidth:h,lutHeight:l,lutPadding:v,lutGamma:m}=r,d=2*v+h,g=2*v+l,p=f(d/h*e),x=f(g/l*o),_=b({width:p,height:x}),y=t(n);_.fillStyle="#00f",_.fillRect(0,0,p,x),_.translate(p/2,x/2),_.fillStyle="#000",_.fillRect(-e/2,-o/2,e,o),_.translate(0,o*(.5-c)),_.fillStyle="#fff",_.textAlign="center",_.font=`${o}px ${i}`;for(let t=0,n=1,r=1;a>t;[n,r]=[r,r+n])_.filter=`blur(${r}px)`,_.globalAlpha=(++t/a)**u,_.fillText(y,0,0);const w=new C(h,l),M=$(_,d,g).getImageData(v,v,h,l).data;for(let t=0;w.length>t;t++)w[t]=s(M[t<<2]/255)**m;return w}static combine(t){const n=t[0].length,r=t.length,e=new C(n,r);for(let o=0;r>o;o++)e.set(t[o],o*n);return e}normalize(t,n){for(let r=this.length;r--;)this[r]=(this[r]-t)/(n-t)}compare(t){let n=0;for(let r=this.length;r--;)n+=a(this[r]-t[r]);return n}}const F={charSet:e,fontFamily:"monospace",fontBase:.25,fontWidth:40,fontHeight:70,fontBlur:9,fontGamma:1,lutWidth:5,lutHeight:7,lutPadding:1,lutMin:0,lutMax:1,lutGamma:1,brightness:1,gamma:1,noise:0},P=t=>{const n=y(n=>n.font=`1em ${t}`)(),r=n.measureText(" ");return t=>n.measureText(t).width===r.width};class S{constructor(t){this.t=(()=>{const t=M();return(n,r,e)=>{const[o,i]=_(n);return r!==o||e!==i?t(n,r,e):n}})(),this.settings={...F,...t},this.o=this.i(),this.s=this.u()}i(){const{charSet:t,fontFamily:r}=this.settings,e=[...t].filter(P(r)).map(n);return Int32Array.from(e)}u(){const{o:t,settings:n}=this,{lutMin:r,lutMax:e}=n,o=Array.from(t,t=>C.fromCharCode(t,n)),i=o.reduce((t,n)=>h(t,...n),0);for(const t of o)t.normalize(r*i,e*i);return o}render(t,n,r){return[...this.lines(t,c(n),c(r))].join("\n")}}class R extends S{*lines(n,r,e){const{settings:o,o:i,s:a,t:u}=this,{lutWidth:c,lutHeight:h,brightness:f,gamma:v,noise:m}=o,d=c*r,g=h*e,p=(t=>t instanceof CanvasRenderingContext2D?t:x(t))(u(n,d,g)).getImageData(0,0,d,g).data,_=new C(c,h);for(let n=0;g>n;n+=h){const r=[];for(let t=0;d>t;t+=c){let e=0,o=1/0;for(let r=0;h>r;r++)for(let o=0;c>o;o++){let i=t+o+(n+r)*d<<2;const a=f*(.2126*s(p[i++]/255)+.7152*s(p[i++]/255)+.0722*s(p[i++]/255))**v,u=m*(l()-.5);_[e++]=a+u}for(let t=a.length;t--;){const n=a[t].compare(_);o>n&&(o=n,e=t)}r.push(i[e])}yield t(...r)}}}const U=(t,n,r)=>{const e=`#version 300 es\n${r}`,o=t.createShader(n);if(t.shaderSource(o,e),t.compileShader(o),!t.getShaderParameter(o,35713))throw Error(`Shader error:\n${t.getShaderInfoLog(o)}\n${B(e)}\n`);return o},G=(t,n,r)=>{const e=t.createProgram();if(t.attachShader(e,n),t.attachShader(e,r),t.linkProgram(e),!t.getProgramParameter(e,35714))throw Error(`Program error: ${t.getProgramInfoLog(e)}`);return e},L=(t,n=3553)=>{const r=t.createTexture();return z(t,r,r=>t.bindTexture(n,r))},A=(t,n)=>r=>t.getUniformLocation(n,r),B=(t,n=1)=>t.replace(/^/gm,()=>`${n++}: `.padStart(5,"0")),z=(t,n,r)=>e=>(e&&(r(n),e(t,n),r(null)),n),E="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = 0.5 + 0.5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",T="#define MAP3(f, v) vec3(f(v.x), f(v.y), f(v.z))\n#define RGB(x) mix(x/12.92, pow((x+.055)/1.055, 2.4), step(.04045, x))\n#define LUM(x) dot(x, vec3(.2126, .7152, .0722))\nprecision highp float;\nuniform sampler2D uSrc;\nuniform float uBrightness;\nuniform float uGamma;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout vec4 vFragColor;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 0.1031);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec3 srgb = texture(uSrc, vPosition).rgb;\nfloat signal = uBrightness * pow(LUM(MAP3(RGB, srgb)), uGamma);\nfloat noise = uNoise * (hash13(vec3(gl_FragCoord.xy, 1000.*uRandom)) - 0.5);\nvFragColor = vec4(vec3(clamp(signal + noise, 0., 1.)), 0.);\n}\n",H="#define U ${ width }\n#define V ${ height }\n#define X ${ width * height }\n#define Y ${ chars }\nprecision highp float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nuniform int uCharMap[Y];\nin vec2 vPosition;\nout vec4 vFragColor;\nstruct Result {\nint index;\nfloat value;\n};\nvoid main() {\nResult res = Result(0, float(X));\nivec2 pos = ivec2(vec2(textureSize(uSrc, 0))*vPosition) - ivec2(U, V)/2;\nfloat src[X];\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, pos + ivec2(u, v), 0).r;\nfor (int y = 0; y < Y; y++) {\nfloat value = 0.;\nfor (int x = 0; x < X; x++)\nvalue += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (res.value > value)\nres = Result(y, value);\n}\nvFragColor = vec4(uCharMap[res.index], 0, 0, 0);\n}\n",W=t=>{t.texParameteri(3553,10241,9728),t.texParameteri(3553,10240,9728)};class D extends S{constructor(t){super(t),this.h=((t,...n)=>{const r=d("canvas")().getContext("webgl2",t);if(!r)throw Error("WebGL2 is not available");for(const t of n)if(!r.getExtension(t))throw Error(`"${t}" extension is not available`);return r})({},"EXT_color_buffer_float"),this.l=((t,n=36160)=>{const r=t.createFramebuffer();return z(t,r,r=>t.bindFramebuffer(n,r))})(this.h)(),this.v=L(this.h)(W),this.m=L(this.h)(W),this.g=L(this.h)(W),this.p=C.combine(this.s),this._=new Float32Array;const n=U(this.h,35633,E),r=U(this.h,35632,T),e=U(this.h,35632,((t,n={},r="$")=>Function(`{${Object.keys(n)}}`,r,`return \`${t}\``)(n,n))(H,{chars:this.o.length,width:this.settings.lutWidth,height:this.settings.lutHeight}));var o;this.M=G(this.h,n,r),this.$=G(this.h,n,e),((t,n=34962)=>{const r=t.createBuffer();return z(t,r,r=>t.bindBuffer(n,r))})(this.h)((o=0,t=>{const n=Float32Array.of(1,1,-1,1,1,-1,-1,-1);t.bufferData(34962,n,35044),t.vertexAttribPointer(o,2,5126,!1,0,0),t.enableVertexAttribArray(o)}))}*lines(n,r,e){const{settings:o,o:i,p:s,h:a,t:u}=this,{M:c,$:h,l:f,v,m,g:d}=this,g=o.lutWidth*r,x=o.lutHeight*e,_=p(u(n,g,x)),y=A(a,c),w=A(a,h),M=r*e,b=M<<2;this._.length!==b&&(this._=new Float32Array(b)),a.bindFramebuffer(36160,f),a.activeTexture(33986),a.bindTexture(3553,v),a.texImage2D(3553,0,33326,s.width,s.height,0,6403,5126,s),a.activeTexture(33985),a.bindTexture(3553,m),a.texImage2D(3553,0,6408,6408,5121,_),a.activeTexture(33984),a.bindTexture(3553,d),a.texImage2D(3553,0,33326,g,x,0,6403,5126,null),a.framebufferTexture2D(36160,36064,3553,d,0),a.useProgram(c),a.uniform1i(y("uSrc"),1),a.uniform1f(y("uBrightness"),o.brightness),a.uniform1f(y("uGamma"),o.gamma),a.uniform1f(y("uNoise"),o.noise),a.uniform1f(y("uRandom"),l()),a.viewport(0,0,g,x),a.drawArrays(5,0,4),a.activeTexture(33985),a.bindTexture(3553,d),a.activeTexture(33984),a.bindTexture(3553,m),a.texImage2D(3553,0,33326,g,x,0,6403,5126,null),a.framebufferTexture2D(36160,36064,3553,m,0),a.useProgram(h),a.uniform1i(w("uSrc"),1),a.uniform1i(w("uLUT"),2),a.uniform1iv(w("uCharMap"),i),a.viewport(0,0,r,e),a.drawArrays(5,0,4),a.readPixels(0,0,r,e,6408,5126,this._),a.bindFramebuffer(36160,null);for(let t=0;M>t;t++)this._[t]=this._[t<<2];for(let n=0;M>n;)yield t(...this._.subarray(n,n+=r))}}export{R as CPURenderer,D as GPURenderer,C as LUT,S as Renderer,i as charSets,F as defaults,P as monospaced};
//# sourceMappingURL=bundle.esm.min.js.map
