const t=String.fromCharCode,n=t=>t.charCodeAt(0),r=Object.assign,e=r,o=r=>{const[e,o]=[...r].map(n),i=[...Array(o-e).keys()].map(t=>e+t);return t(...i,o)},i=o(" ^")+o("`~"),s=i+o("¡§")+"®°±©«¬´µ·»¿×÷",a={__proto__:null,ascii:i,extended:s,extra:s+o("‘•")+"‹›∙√∞"},c=CanvasRenderingContext2D,u=(l="canvas",(...t)=>e(document.createElement(l),...t));var l;const f=(t,n)=>r([t,n,t/n],{width:t,height:n,ratio:t/n}),h=t=>t instanceof c?t.canvas:t,d=t=>{if(t instanceof HTMLVideoElement)return f(t.videoWidth,t.videoHeight);if(t instanceof HTMLImageElement)return f(t.naturalWidth,t.naturalHeight);const n=h(t);return f(n.width,n.height)},m=t=>{const n=u().getContext("2d");return(r,o)=>{var i;return e(n.canvas,{width:r,height:o}),null===(i=t)||void 0===i||i(n),n}},{abs:v,clz32:p,floor:g,max:x,random:_,round:y}=Math,P=(t,n,r)=>.2126*t+.7152*n+.0722*r,w=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,$=t=>1<<x(0,31-p(t)),M=()=>{const t=(()=>{const t=m();return(n,r,e)=>{const o=t(r,e);return o.drawImage(h(n),0,0,r,e),o}})(),n=(()=>{const t=m();return(n,r,e,o=0,i=0)=>{const s=t(r,e);return s.drawImage(h(n),o,i,r,e,0,0,r,e),s}})();return(r,e,o)=>{const[i,s]=d(r);let a=e*$(i/e-1),c=o*$(s/o-1);const u=t(r,a,c);if(e===a&&o===c)return u;for(let t,n;t=a>e,n=c>o,t||n;)u.drawImage(u.canvas,0,0,a,c,0,0,a>>=+t,c>>=+n);return n(u,e,o)}},S=m(),C=M();class b extends Float32Array{constructor(t,n){super(t*n),this.width=t,this.height=n}static fromCharCode(n,r){const{fontWidth:e,fontHeight:o,fontFamily:i,fontBlur:s,fontGamma:a}=r,{fontBase:c,lutWidth:u,lutHeight:l,lutPadding:f,lutGamma:h}=r,d=2*f+u,m=2*f+l,v=y(d/u*e),p=y(m/l*o),g=S(v,p),x=t(n);g.fillStyle="#00f",g.fillRect(0,0,v,p),g.translate(v/2,p/2),g.fillStyle="#000",g.fillRect(-e/2,-o/2,e,o),g.translate(0,o*(.5-c)),g.fillStyle="#fff",g.textAlign="center",g.font=`${o}px ${i}`;for(let t=0,n=1,r=1;s>t;[n,r]=[r,r+n])g.filter=`blur(${r}px)`,g.globalAlpha=(++t/s)**a,g.fillText(x,0,0);const _=new b(u,l),P=C(g,d,m).getImageData(f,f,u,l).data;for(let t=0;_.length>t;t++)_[t]=w(P[t<<2]/255)**h;return _}static combine(t){const n=t[0].length,r=t.length,e=new b(n,r);for(let o=0;r>o;o++)e.set(t[o],o*n);return e}normalize(t,n){for(let r=this.length;r--;)this[r]=(this[r]-t)/(n-t)}compare(t){let n=0;for(let r=this.length;r--;)n+=v(this[r]-t[r]);return n}}const U={charSet:i,fontFamily:"monospace",fontBase:.25,fontWidth:40,fontHeight:70,fontBlur:9,fontGamma:1,lutWidth:5,lutHeight:7,lutPadding:1,lutMin:0,lutMax:1,lutGamma:1,gamma:1,signal:1,noise:0},B=t=>{const n=m(n=>n.font=`1em ${t}`)(0,0),r=n.measureText(" ");return t=>n.measureText(t).width===r.width};class G{constructor(t){this.t=(()=>{const t=M();return(n,r,e)=>{const[o,i]=d(n);return r!==o||e!==i?t(n,r,e):n}})();const r={...U,...t},{charSet:e,fontFamily:o,lutMin:i,lutMax:s}=r,a=[...e].filter(B(o)).map(n),c=Array.from(a,t=>b.fromCharCode(t,r)),u=c.reduce((t,n)=>x(t,...n),0);for(const t of c)t.normalize(i*u,s*u);this.settings=r,this.o=Uint32Array.from(a),this.i=c}render(t,n,r){return[...this.s(t,g(n),g(r))].join("\n")}}class L extends G{constructor(){super(...arguments),this.u=(()=>{const t=m();return n=>{const[r,e]=d(n),o=t(r,e);return o.drawImage(h(n),0,0),o}})()}*s(n,r,e){const{settings:o,o:i,i:s,t:a,u:c}=this,{lutWidth:u,lutHeight:l,gamma:f,signal:h,noise:d}=o,m=u*r,v=l*e,p=c(a(n,m,v)).getImageData(0,0,m,v).data,g=new b(u,l);for(let n=0;v>n;n+=l){const r=[];for(let t=0;m>t;t+=u){let e=0,o=1/0;for(let r=0;l>r;r++)for(let o=0;u>o;o++){let i=t+o+(n+r)*m<<2;const s=w(p[i++]/255),a=w(p[i++]/255),c=w(p[i++]/255),u=P(s,a,c)**f,l=_()-.5;g[e++]=h*u+d*l}for(let t=s.length;t--;){const n=s[t].compare(g);o>n&&(o=n,e=t)}r.push(i[e])}yield t(...r)}}}const R=(t,n,r)=>e=>(e&&(r(n),e(t,n),r(null)),n),A=(t,n)=>r=>t.getUniformLocation(n,r),z=(t,n=3553)=>{const r=t.createTexture();return R(t,r,r=>t.bindTexture(n,r))},E=(t,n,r)=>{const e=`#version 300 es\n${r}`,o=t.createShader(n);if(t.shaderSource(o,e),t.compileShader(o),!t.getShaderParameter(o,35713)){const n=t.getShaderInfoLog(o);throw Error(`Shader error:\n${n}\n${((t,n=1)=>t.replace(/^/gm,()=>`${n++}: `.padStart(5,"0")))(e)}\n`)}return o},F=(t,n,r)=>{const e=t.createProgram();if(t.attachShader(e,n),t.attachShader(e,r),t.linkProgram(e),!t.getProgramParameter(e,35714)){const n=t.getProgramInfoLog(e);throw Error(`Program error: ${n}`)}return e},H="in vec2 aPosition;out vec2 vPosition;void main(){vPosition=.5+.5*aPosition;gl_Position=vec4(aPosition,0.,1.);}",T="#define MAP3(fn,v3)vec3(fn(v3.x),fn(v3.y),fn(v3.z))\n#define RGB(v1)mix(v1/12.92,pow((v1+.055)/1.055,2.4),step(.04045,v1))\n#define LUM(v3)dot(MAP3(RGB,v3),vec3(.2126,.7152,.0722))\nprecision highp float;uniform sampler2D uSrc;uniform float uGamma;uniform float uSignal;uniform float uNoise;uniform float uRandom;in vec2 vPosition;out float Result;float hash13(vec3 p3){p3=fract(p3*1031.);p3+=dot(p3,p3.yzx+19.19);return fract((p3.x+p3.y)*p3.z);}void main(){vec4 t=texture(uSrc,vPosition);float s=pow(LUM(t),uGamma);float n=hash13(vec3(vPosition,uRandom))-0.5;Result=uSignal*s+uNoise*n;}",W="#define U ${width}\n#define V ${height}\n#define X ${width*height}\n#define Y ${chars}\n#define Inf exp(1000.)\n#define Block float[X]\n#define CharCode uint\nprecision highp float;uniform sampler2D uSrc;uniform sampler2D uLUT;uniform CharCode uCharMap[Y];in vec2 vPosition;out CharCode Result;Block read(){vec2 center=vec2(textureSize(uSrc,0))*vPosition;ivec2 topLeft=ivec2(center+.25)-ivec2(U,V)/2;Block src;for(int v=0;v<V;v++)for(int u=0;u<U;u++)src[U*v+u]=texelFetch(uSrc,topLeft+ivec2(u,v),0).r;return src;}CharCode closest(Block src){struct Pair{float diff;int idx;};Pair closest=Pair(Inf,0);for(int y=0;y<Y;y++){float diff=0.;for(int x=0;x<X;x++)diff+=abs(src[x]-texelFetch(uLUT,ivec2(x,y),0).r);if(closest.diff>diff)closest=Pair(diff,y);}return uCharMap[closest.idx];}void main(){Result=closest(read());}",k=t=>{t.texParameteri(3553,10241,9728),t.texParameteri(3553,10240,9728)};class D extends G{constructor(t){super(t),this.l=new Uint32Array;const n=((t,...n)=>{const r=u().getContext("webgl2",t);if(!r)throw Error("WebGL2 is unavailable");for(const t of n)if(!r.getExtension(t))throw Error(`"${t}" extension is unavailable`);return r})({},"EXT_color_buffer_float"),r=E(n,35633,H),e=E(n,35632,T),o=E(n,35632,((t,n={},r="$")=>Function(`{${Object.keys(n)}}`,r,`return \`${t}\``)(n,n))(W,{chars:this.o.length,width:this.settings.lutWidth,height:this.settings.lutHeight}));this.h=n,this.m=((t,n=36160)=>{const r=t.createFramebuffer();return R(t,r,r=>t.bindFramebuffer(n,r))})(n)(),this.v=z(n)(k),this.p=z(n)(k),this.g=z(n)(k),this._=F(n,r,e),this.P=F(n,r,o);const i=b.combine(this.i);var s;n.activeTexture(33986),n.bindTexture(3553,this.v),n.texImage2D(3553,0,33326,i.width,i.height,0,6403,5126,i),((t,n=34962)=>{const r=t.createBuffer();return R(t,r,r=>t.bindBuffer(n,r))})(n)((s=0,t=>{const n=Float32Array.of(1,1,-1,1,1,-1,-1,-1);t.bufferData(34962,n,35044),t.vertexAttribPointer(s,2,5126,!1,0,0),t.enableVertexAttribArray(s)}))}*s(n,r,e){const{settings:o,o:i,t:s,h:a}=this,{_:c,P:u,m:l,p:f,g:d}=this,m=o.lutWidth*r,v=o.lutHeight*e,p=h(s(n,m,v)),g=A(a,c),x=A(a,u),y=r*e;this.l.length!==y&&(this.l=new Uint32Array(y)),a.bindFramebuffer(36160,l),a.activeTexture(33985),a.bindTexture(3553,f),a.texImage2D(3553,0,6408,6408,5121,p),a.activeTexture(33984),a.bindTexture(3553,d),a.texImage2D(3553,0,33326,m,v,0,6403,5126,null),a.framebufferTexture2D(36160,36064,3553,d,0),a.useProgram(c),a.uniform1i(g("uSrc"),1),a.uniform1f(g("uGamma"),o.gamma),a.uniform1f(g("uSignal"),o.signal),a.uniform1f(g("uNoise"),o.noise),a.uniform1f(g("uRandom"),_()),a.viewport(0,0,m,v),a.drawArrays(5,0,4),a.activeTexture(33985),a.bindTexture(3553,d),a.activeTexture(33984),a.bindTexture(3553,f),a.texImage2D(3553,0,33334,m,v,0,36244,5125,null),a.framebufferTexture2D(36160,36064,3553,f,0),a.useProgram(u),a.uniform1i(x("uSrc"),1),a.uniform1i(x("uLUT"),2),a.uniform1uiv(x("uCharMap"),i),a.viewport(0,0,r,e),a.drawArrays(5,0,4),a.readPixels(0,0,r,e,36244,5125,this.l),a.bindFramebuffer(36160,null);for(let n=0;y>n;)yield t(...this.l.subarray(n,n+=r))}}export{L as CPURenderer,c as Context,D as GPURenderer,b as LUT,G as Renderer,a as charSets,U as defaults,B as monospaced};
//# sourceMappingURL=bundle.esm.min.js.map
