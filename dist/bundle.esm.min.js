function*t(t=0,e=1/0,r=1){for(let n=t;e>n;n+=r)yield n}const e=Object.assign,r=t=>{const e=new Set;for(let r=t;r&&r!==Object.prototype;r=Object.getPrototypeOf(r))Object.getOwnPropertyNames(r).forEach(t=>e.add(t));return e},n=(...t)=>(...r)=>e(i("canvas")(...t).getContext("2d"),...r),i=t=>(...r)=>e(document.createElement(t),...r),a=String.fromCharCode,s=t=>t.charCodeAt(0),o=t=>{const e=n()({font:`1em ${t}`}),r=e.measureText(" ");return t=>e.measureText(t).width===r.width},l=a(...t(32,95),...t(96,127),...t(161,168),...t(174,178),169,171,172,180,181,183,187,191,215,247,...t(8216,8227),8249,8250,8729,8730,8734),h=l.replace(/[^\x00-\x7f]/g,""),u=l.replace(/[^\x00-\xff]/g,""),c={__proto__:null,ascii:h,extended:u,unicode:l};class f{constructor(){this.alphabet=h,this.quality="high",this.fontFace="monospace",this.fontWidth=40,this.fontHeight=70,this.fontBlur=9,this.fontGamma=1,this.lutWidth=5,this.lutHeight=7,this.lutPadding=1,this.lutMin=0,this.lutMax=1,this.lutGamma=1,this.brightness=1,this.gamma=1,this.noise=0}}const{abs:g,clz32:m,floor:d,max:x,random:v,round:p}=Math,b=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,y=t=>1<<x(0,31-m(t)),w="imageSmoothingQuality"in CanvasRenderingContext2D.prototype?(t,e,r)=>{const i=n({width:e,height:r})({imageSmoothingQuality:"medium"});return i.drawImage(t.canvas,0,0,e,r),i}:(t,e,r)=>{let i=y(t.canvas.width/e-1)*e,a=y(t.canvas.height/r-1)*r;const s=n({width:i,height:a})();s.drawImage(t.canvas,0,0,i,a);for(let t,n;n=a>r,(t=i>e)||n;)s.drawImage(s.canvas,0,0,i,a,0,0,i>>=+t,a>>=+n);const o=n({width:e,height:r})();return o.drawImage(s.canvas,0,0),o};class P extends Float32Array{constructor(t,e){super(t*e),this.width=t,this.height=e}static fromCharCode(t,e){const{fontWidth:r,fontHeight:i,fontFace:s,fontBlur:o,fontGamma:l}=e,{lutWidth:h,lutHeight:u,lutPadding:c,lutGamma:f}=e,g=2*c+h,m=2*c+u,d=p(g/h*r),x=p(m/u*i),v=n({width:d,height:x})(),y=a(t);v.fillStyle="#00f",v.fillRect(0,0,d,x),v.translate(d/2,x/2),v.fillStyle="#000",v.fillRect(-r/2,-i/2,r,i),v.translate(0,i/4),v.fillStyle="#fff",v.textAlign="center",v.font=`${i}px ${s}`;for(let t=0,e=1,r=1;o>t;[e,r]=[r,r+e])v.filter=`blur(${r}px)`,v.globalAlpha=(++t/o)**l,v.fillText(y,0,0);const T=w(v,g,m).getImageData(c,c,h,u).data,S=new P(h,u);for(let t=0;S.length>t;t++)S[t]=b(T[t<<2]/255)**f;return S}static combine(...t){const e=t[0].length,r=t.length,n=new P(e,r);for(let i=0;r>i;i++)n.set(t[i],i*e);return n}normalize(t,e){for(let r=0;this.length>r;r++)this[r]=(this[r]-t)/(e-t)}compare(t){let e=0;for(let r=this.length;r--;)e+=g(this[r]-t[r]);return e}}class T{constructor(t){this.settings=new f,e(this.settings,t),this.api=n()(),this.charMap=this.makeCharMap(),this.luts=this.makeLUTs()}makeCharMap(){const{alphabet:t,fontFace:e}=this.settings,r=[...t].filter(o(e)).map(s);return Uint16Array.from(r)}makeLUTs(){const{charMap:t,settings:e}=this,{lutMin:r,lutMax:n}=e,i=Array.from(t,t=>P.fromCharCode(t,e)),a=i.reduce((t,e)=>x(t,...e),0);for(const t of i)t.normalize(r*a,n*a);return i}resize(t,r,n){const{api:i,settings:a}=this;return e(i.canvas,{width:r,height:n}),i.imageSmoothingQuality=a.quality,i.drawImage(t,0,0,r,n),i}render(t,e,r){return[...this.lines(t,d(e),d(r))].join("\n")}}class S extends T{*lines(t,e,r){const{settings:n,charMap:i,luts:s}=this,{lutWidth:o,lutHeight:l,brightness:h,gamma:u,noise:c}=n,f=o*e,g=l*r,m=this.resize(t,f,g).getImageData(0,0,f,g).data,d=new Float32Array(o*l);for(let t=0;g>t;t+=l){const e=[];for(let r=0;f>r;r+=o){let n=0,a=1/0;for(let e=0;l>e;e++)for(let i=0;o>i;i++){let a=r+i+(t+e)*f<<2;const s=h*(.2126*b(m[a++]/255)+.7152*b(m[a++]/255)+.0722*b(m[a++]/255))**u,o=c*(v()-.5);d[n++]=s+o}for(let t=s.length;t--;){const e=s[t].compare(d);a>e&&(a=e,n=t)}e.push(i[n])}yield a(...e)}}}const F=5,A=5121,C=5126,M=6408,$=35632,U=35633,D=3553,I=33984,L=36160,R=36064,z=6403,E=33326,G=(t,...e)=>{const r=i("canvas")().getContext("webgl2",t);if(!r)throw Error("WebGL2 is not available");for(const t of e)if(!r.getExtension(t))throw Error(`"${t}" extension is not available`);return r},B=(t,e,r)=>{const n="#version 300 es\n"+r,i=t.createShader(e);if(t.shaderSource(i,n),t.compileShader(i),!t.getShaderParameter(i,35713))throw Error(`Shader error:\n${t.getShaderInfoLog(i)}\n${k(n)}\n`);return i},_=(t,e,r)=>{const n=t.createProgram();if(t.attachShader(n,e),t.attachShader(n,r),t.linkProgram(n),!t.getProgramParameter(n,35714))throw Error(`Program error: ${t.getProgramInfoLog(n)}`);return n},O=(t,e=34962)=>{const r=t.createBuffer();return X(t,r,r=>t.bindBuffer(e,r))},W=(t,e=D)=>{const r=t.createTexture();return X(t,r,r=>t.bindTexture(e,r))},H=(t,e=L)=>{const r=t.createFramebuffer();return X(t,r,r=>t.bindFramebuffer(e,r))},j=(t,e)=>r=>t.getUniformLocation(e,r),k=(t,e=1)=>t.replace(/^.*/gm,t=>((t,e)=>"0".repeat(x(0,t-e.length))+e)(5,`${e++}: `)+t),X=(t,e,r)=>n=>(n&&(r(e),n(t,e),r(null)),e),N=(t,e={},n="$")=>Function(`{${[...r(e)]}}`,n,`return \`${t}\``)(e,e),V="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = 0.5 + 0.5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",Q="#define MAP3(f, v) vec3(f(v.x), f(v.y), f(v.z))\n#define RGB(x) mix(x/12.92, pow((x+.055)/1.055, 2.4), step(.04045, x))\n#define LUM(x) dot(x, vec3(.2126, .7152, .0722))\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform float uBrightness;\nuniform float uGamma;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout vec4 vFragColor;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 0.1031);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec3 srgb = texture(uSrc, vPosition).rgb;\nfloat signal = uBrightness * pow(LUM(MAP3(RGB, srgb)), uGamma);\nfloat noise = uNoise * (hash13(vec3(gl_FragCoord.xy, 1000.*uRandom)) - 0.5);\nvFragColor = vec4(vec3(clamp(signal + noise, 0., 1.)), 0.);\n}\n",q="#define U ${settings.lutWidth}\n#define V ${settings.lutHeight}\n#define X ${lut.width}\n#define Y ${lut.height}\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nin vec2 vPosition;\nout vec4 vFragColor;\nstruct Result {\nint index;\nfloat value;\n};\nvoid main() {\nResult res = Result(0, float(X));\nivec2 pos = ivec2(vec2(textureSize(uSrc, 0))*vPosition) - ivec2(U, V)/2;\nfloat src[X];\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, pos + ivec2(u, v), 0).r;\nfor (int y = 0; y < Y; y++) {\nfloat value = 0.;\nfor (int x = 0; x < X; x++)\nvalue += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (res.value > value)\nres = Result(y, value);\n}\nvFragColor = vec4(res.index, 0, 0, 0);\n}\n",Y=t=>{t.texParameteri(D,10241,9728),t.texParameteri(D,10240,9728)},J=t=>e=>{const r=Float32Array.of(1,1,-1,1,1,-1,-1,-1);e.bufferData(34962,r,35044),e.vertexAttribPointer(t,2,C,!1,0,0),e.enableVertexAttribArray(t)};class K extends T{constructor(t){super(t),this.gl=G({},"EXT_color_buffer_float"),this.fbo=H(this.gl)(),this.txLUT=W(this.gl)(Y),this.txOdd=W(this.gl)(Y),this.txEven=W(this.gl)(Y),this.lut=P.combine(...this.luts),this.indices=new Float32Array;const e=B(this.gl,U,N(V,this)),r=B(this.gl,$,N(Q,this)),n=B(this.gl,$,N(q,this));this.pass1=_(this.gl,e,r),this.pass2=_(this.gl,e,n),O(this.gl)(J(0))}*lines(t,e,r){const{settings:n,charMap:i,lut:s,gl:o,pass1:l,pass2:h,fbo:u,txLUT:c,txOdd:f,txEven:g}=this,m=n.lutWidth*e,d=n.lutHeight*r,x=this.resize(t,m,d).canvas,v=j(o,l),p=j(o,h);this.indices.length!==e*r&&(this.indices=new Float32Array(e*r)),o.bindFramebuffer(L,u),o.activeTexture(I+2),o.bindTexture(D,c),o.texImage2D(D,0,E,s.width,s.height,0,z,C,s),o.activeTexture(I+1),o.bindTexture(D,f),o.texImage2D(D,0,M,M,A,x),o.activeTexture(I+0),o.bindTexture(D,g),o.texImage2D(D,0,E,m,d,0,z,C,null),o.framebufferTexture2D(L,R,D,g,0),o.useProgram(l),o.uniform1i(v("uSrc"),1),o.uniform1f(v("uBrightness"),n.brightness),o.uniform1f(v("uGamma"),n.gamma),o.uniform1f(v("uNoise"),n.noise),o.uniform1f(v("uRandom"),Math.random()),o.viewport(0,0,m,d),o.drawArrays(F,0,4),o.activeTexture(I+1),o.bindTexture(D,g),o.activeTexture(I+0),o.bindTexture(D,f),o.texImage2D(D,0,E,m,d,0,z,C,null),o.framebufferTexture2D(L,R,D,f,0),o.useProgram(h),o.uniform1i(p("uSrc"),1),o.uniform1i(p("uLUT"),2),o.viewport(0,0,e,r),o.drawArrays(F,0,4),o.readPixels(0,0,e,r,z,C,this.indices),o.bindFramebuffer(L,null);for(let t=0;this.indices.length>t;){const r=this.indices.subarray(t,t+=e),n=Array.from(r,t=>i[t]);yield a(...n)}}}export{S as CPURenderer,K as GPURenderer,P as LUT,T as Renderer,f as Settings,c as alphabets};
//# sourceMappingURL=bundle.esm.min.js.map
