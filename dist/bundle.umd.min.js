((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).ascii={})})(this,(function(t){"use strict";function*e(t=0,e=1/0,r=1){for(let n=t;e>n;n+=r)yield n}const r=Object.assign,n=t=>{const e=new Set;for(let r=t;r&&r!==Object.prototype;r=Object.getPrototypeOf(r))Object.getOwnPropertyNames(r).forEach(t=>e.add(t));return e},i=(...t)=>(...e)=>r(a("canvas")(...t).getContext("2d"),...e),a=t=>(...e)=>r(document.createElement(t),...e),o=String.fromCharCode,s=t=>t.charCodeAt(0),l=t=>{const e=i()({font:`1em ${t}`}),r=e.measureText(" ");return t=>e.measureText(t).width===r.width},u=o(...e(32,95),...e(96,127),...e(161,168),...e(174,178),169,171,172,180,181,183,187,191,215,247,...e(8216,8227),8249,8250,8729,8730,8734),h=u.replace(/[^\x00-\xff]/g,""),f=u.replace(/[^\x00-\x7f]/g,""),c={__proto__:null,unicode:u,extended:h,ascii:f},d=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,{abs:m,clz32:g,floor:x,max:v,random:p,round:b}=Math,y=t=>1<<v(0,31-g(t)),P=(t,e,r)=>{const n=(t=>t instanceof CanvasRenderingContext2D?t.canvas:t)(t);let a=e*y(n.width/e-1),o=r*y(n.height/r-1);const s=i({width:a,height:o})();if(s.drawImage(n,0,0,a,o),e===a&&r===o)return s;for(let t,n;t=a>e,n=o>r,t||n;)s.drawImage(s.canvas,0,0,a,o,0,0,a>>=+t,o>>=+n);const l=i({width:e,height:r})();return l.drawImage(s.canvas,0,0),l},w=(t,e)=>{const{fontWidth:r,fontHeight:n,fontFamily:a,fontBlur:s,fontGamma:l}=e,{fontBase:u,lutWidth:h,lutHeight:f,lutPadding:c,lutGamma:m}=e,g=2*c+h,x=2*c+f,v=b(g/h*r),p=b(x/f*n),y=i({width:v,height:p})(),w=o(t);y.fillStyle="#00f",y.fillRect(0,0,v,p),y.translate(v/2,p/2),y.fillStyle="#000",y.fillRect(-r/2,-n/2,r,n),y.translate(0,n*(.5-u)),y.fillStyle="#fff",y.textAlign="center",y.font=`${n}px ${a}`;for(let t=0,e=1,r=1;s>t;[e,r]=[r,r+e])y.filter=`blur(${r}px)`,y.globalAlpha=(++t/s)**l,y.fillText(w,0,0);const T=new S(h,f),C=P(y,g,x).getImageData(c,c,h,f).data;for(let t=0;T.length>t;t++)T[t]=d(C[t<<2]/255)**m;return T},T=t=>{const e=t[0].length,r=t.length,n=new S(e,r);for(let i=0;r>i;i++)n.set(t[i],i*e);return n};class S extends Float32Array{constructor(t,e){super(t*e),this.width=t,this.height=e}normalize(t,e){for(let r=0;this.length>r;r++)this[r]=(this[r]-t)/(e-t)}compare(t){let e=0;for(let r=this.length;r--;)e+=m(this[r]-t[r]);return e}}class C{constructor(){this.charSet=f,this.fontFamily="monospace",this.fontBase=.25,this.fontWidth=40,this.fontHeight=70,this.fontBlur=9,this.fontGamma=1,this.lutWidth=5,this.lutHeight=7,this.lutPadding=1,this.lutMin=0,this.lutMax=1,this.lutGamma=1,this.brightness=1,this.gamma=1,this.noise=0}}class F{constructor(t){this.settings=new C,r(this.settings,t),this.api=i()(),this.charMap=this.makeCharMap(),this.luts=this.makeLUTs()}makeCharMap(){const{charSet:t,fontFamily:e}=this.settings,r=[...t].filter(l(e)).map(s);return Int32Array.from(r)}makeLUTs(){const{charMap:t,settings:e}=this,{lutMin:r,lutMax:n}=e,i=Array.from(t,t=>w(t,e)),a=i.reduce((t,e)=>v(t,...e),0);for(const t of i)t.normalize(r*a,n*a);return i}render(t,e,r){return[...this.lines(t,x(e),x(r))].join("\n")}}const M=(t,e={},r="$")=>Function(`{${[...n(e)]}}`,r,`return \`${t}\``)(e,e),A=5,U=5121,$=5126,R=6408,L=35632,D=35633,I=3553,B=33984,G=36160,_=36064,E=6403,O=33326,W=(t,...e)=>{const r=a("canvas")().getContext("webgl2",t);if(!r)throw Error("WebGL2 is not available");for(const t of e)if(!r.getExtension(t))throw Error(`"${t}" extension is not available`);return r},j=(t,e,r)=>{const n="#version 300 es\n"+r,i=t.createShader(e);if(t.shaderSource(i,n),t.compileShader(i),!t.getShaderParameter(i,35713))throw Error(`Shader error:\n${t.getShaderInfoLog(i)}\n${V(n)}\n`);return i},z=(t,e,r)=>{const n=t.createProgram();if(t.attachShader(n,e),t.attachShader(n,r),t.linkProgram(n),!t.getProgramParameter(n,35714))throw Error(`Program error: ${t.getProgramInfoLog(n)}`);return n},H=(t,e=34962)=>{const r=t.createBuffer();return Y(t,r,r=>t.bindBuffer(e,r))},k=(t,e=I)=>{const r=t.createTexture();return Y(t,r,r=>t.bindTexture(e,r))},X=(t,e=G)=>{const r=t.createFramebuffer();return Y(t,r,r=>t.bindFramebuffer(e,r))},N=(t,e)=>r=>t.getUniformLocation(e,r),V=(t,e=1)=>t.replace(/^.*/gm,t=>((t,e)=>"0".repeat(v(0,t-e.length))+e)(5,`${e++}: `)+t),Y=(t,e,r)=>n=>(n&&(r(e),n(t,e),r(null)),e),q="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = 0.5 + 0.5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",J="#define MAP3(f, v) vec3(f(v.x), f(v.y), f(v.z))\n#define RGB(x) mix(x/12.92, pow((x+.055)/1.055, 2.4), step(.04045, x))\n#define LUM(x) dot(x, vec3(.2126, .7152, .0722))\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform float uBrightness;\nuniform float uGamma;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout vec4 vFragColor;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 0.1031);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec3 srgb = texture(uSrc, vPosition).rgb;\nfloat signal = uBrightness * pow(LUM(MAP3(RGB, srgb)), uGamma);\nfloat noise = uNoise * (hash13(vec3(gl_FragCoord.xy, 1000.*uRandom)) - 0.5);\nvFragColor = vec4(vec3(clamp(signal + noise, 0., 1.)), 0.);\n}\n",K="#define U ${settings.lutWidth}\n#define V ${settings.lutHeight}\n#define X ${lut.width}\n#define Y ${lut.height}\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nuniform int uCharMap[Y];\nin vec2 vPosition;\nout vec4 vFragColor;\nstruct Result {\nint index;\nfloat value;\n};\nvoid main() {\nResult res = Result(0, float(X));\nivec2 pos = ivec2(vec2(textureSize(uSrc, 0))*vPosition) - ivec2(U, V)/2;\nfloat src[X];\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, pos + ivec2(u, v), 0).r;\nfor (int y = 0; y < Y; y++) {\nfloat value = 0.;\nfor (int x = 0; x < X; x++)\nvalue += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (res.value > value)\nres = Result(y, value);\n}\nvFragColor = vec4(uCharMap[res.index], 0, 0, 0);\n}\n",Q=t=>{t.texParameteri(I,10241,9728),t.texParameteri(I,10240,9728)},Z=t=>e=>{const r=Float32Array.of(1,1,-1,1,1,-1,-1,-1);e.bufferData(34962,r,35044),e.vertexAttribPointer(t,2,$,!1,0,0),e.enableVertexAttribArray(t)};t.CPURenderer=class extends F{*lines(t,e,r){const{settings:n,charMap:i,luts:a}=this,{lutWidth:s,lutHeight:l,brightness:u,gamma:h,noise:f}=n,c=s*e,m=l*r,g=P(t,c,m).getImageData(0,0,c,m).data,x=new Float32Array(s*l);for(let t=0;m>t;t+=l){const e=[];for(let r=0;c>r;r+=s){let n=0,o=1/0;for(let e=0;l>e;e++)for(let i=0;s>i;i++){let a=r+i+(t+e)*c<<2;const o=u*(.2126*d(g[a++]/255)+.7152*d(g[a++]/255)+.0722*d(g[a++]/255))**h,s=f*(p()-.5);x[n++]=o+s}for(let t=a.length;t--;){const e=a[t].compare(x);o>e&&(o=e,n=t)}e.push(i[n])}yield o(...e)}}},t.GPURenderer=class extends F{constructor(t){super(t),this.gl=W({},"EXT_color_buffer_float"),this.fbo=X(this.gl)(),this.txLUT=k(this.gl)(Q),this.txOdd=k(this.gl)(Q),this.txEven=k(this.gl)(Q),this.lut=T(this.luts),this.indices=new Float32Array;const e=j(this.gl,D,M(q,this)),r=j(this.gl,L,M(J,this)),n=j(this.gl,L,M(K,this));this.pass1=z(this.gl,e,r),this.pass2=z(this.gl,e,n),H(this.gl)(Z(0))}*lines(t,e,r){const{settings:n,charMap:i,lut:a,gl:s,pass1:l,pass2:u,fbo:h,txLUT:f,txOdd:c,txEven:d}=this,m=n.lutWidth*e,g=n.lutHeight*r,x=P(t,m,g),v=N(s,l),p=N(s,u);this.indices.length!==e*r&&(this.indices=new Float32Array(e*r)),s.bindFramebuffer(G,h),s.activeTexture(B+2),s.bindTexture(I,f),s.texImage2D(I,0,O,a.width,a.height,0,E,$,a),s.activeTexture(B+1),s.bindTexture(I,c),s.texImage2D(I,0,R,R,U,x.canvas),s.activeTexture(B+0),s.bindTexture(I,d),s.texImage2D(I,0,O,m,g,0,E,$,null),s.framebufferTexture2D(G,_,I,d,0),s.useProgram(l),s.uniform1i(v("uSrc"),1),s.uniform1f(v("uBrightness"),n.brightness),s.uniform1f(v("uGamma"),n.gamma),s.uniform1f(v("uNoise"),n.noise),s.uniform1f(v("uRandom"),Math.random()),s.viewport(0,0,m,g),s.drawArrays(A,0,4),s.activeTexture(B+1),s.bindTexture(I,d),s.activeTexture(B+0),s.bindTexture(I,c),s.texImage2D(I,0,O,m,g,0,E,$,null),s.framebufferTexture2D(G,_,I,c,0),s.useProgram(u),s.uniform1i(p("uSrc"),1),s.uniform1i(p("uLUT"),2),s.uniform1iv(p("uCharMap"),i),s.viewport(0,0,e,r),s.drawArrays(A,0,4),s.readPixels(0,0,e,r,E,$,this.indices),s.bindFramebuffer(G,null);for(let t=0;this.indices.length>t;)yield o(...this.indices.subarray(t,t+=e))}},t.LUT=S,t.Renderer=F,t.Settings=C,t.charSets=c,t.combine=T,t.fromCharCode=w,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=bundle.umd.min.js.map
