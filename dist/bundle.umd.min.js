((t,n)=>{"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).ascii={})})(this,(function(t){"use strict";const n=Object.assign,e=(...t)=>(...e)=>n(i("canvas")(...t).getContext("2d"),...e),i=t=>(...e)=>n(document.createElement(t),...e),s=String.fromCharCode,r=t=>t.charCodeAt(0),o=t=>{const[n,e]=[...t].map(r),i=[...Array(e-n).keys()].map(t=>n+t);return s(...i,e)},a=o(" ^")+o("`~"),h=a+o("¡§")+"®°±©«¬´µ·»¿×÷",u=h+o("‘•")+"‹›∙√∞",c={__proto__:null,ascii:a,extended:h,extra:u},l=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,{abs:f,clz32:d,floor:v,max:m,random:p,round:g}=Math,x=t=>t instanceof CanvasRenderingContext2D?t.canvas:t,_=t=>1<<m(0,31-d(t)),y=(t,n,i)=>{const s=x(t);let r=n*_(s.width/n-1),o=i*_(s.height/i-1);const a=((t,n,i)=>{const s=e({width:n,height:i})();return s.drawImage(x(t),0,0,n,i),s})(t,r,o);if(n===r&&i===o)return a;for(let t,e;t=r>n,e=o>i,t||e;)a.drawImage(a.canvas,0,0,r,o,0,0,r>>=+t,o>>=+e);return((t,n,i,s,r)=>{const o=e({width:s,height:r})();return o.drawImage(x(t),n,i,s,r,0,0,s,r),o})(a,0,0,n,i)},w=(t,n,e)=>{const{width:i,height:s}=x(t);return n!==i||e!==s?y(t,n,e):t};class b extends Float32Array{constructor(t,n){super(t*n),this.width=t,this.height=n}static fromCharCode(t,n){const{fontWidth:i,fontHeight:r,fontFamily:o,fontBlur:a,fontGamma:h}=n,{fontBase:u,lutWidth:c,lutHeight:f,lutPadding:d,lutGamma:v}=n,m=2*d+c,p=2*d+f,x=g(m/c*i),_=g(p/f*r),w=e({width:x,height:_})(),$=s(t);w.fillStyle="#00f",w.fillRect(0,0,x,_),w.translate(x/2,_/2),w.fillStyle="#000",w.fillRect(-i/2,-r/2,i,r),w.translate(0,r*(.5-u)),w.fillStyle="#fff",w.textAlign="center",w.font=`${r}px ${o}`;for(let t=0,n=1,e=1;a>t;[n,e]=[e,e+n])w.filter=`blur(${e}px)`,w.globalAlpha=(++t/a)**h,w.fillText($,0,0);const C=new b(c,f),M=y(w,m,p).getImageData(d,d,c,f).data;for(let t=0;C.length>t;t++)C[t]=l(M[t<<2]/255)**v;return C}static combine(t){const n=t[0].length,e=t.length,i=new b(n,e);for(let s=0;e>s;s++)i.set(t[s],s*n);return i}normalize(t,n){for(let e=this.length;e--;)this[e]=(this[e]-t)/(n-t)}compare(t){let n=0;for(let e=this.length;e--;)n+=f(this[e]-t[e]);return n}}class ${constructor(){this.charSet=a,this.fontFamily="monospace",this.fontBase=.25,this.fontWidth=40,this.fontHeight=70,this.fontBlur=9,this.fontGamma=1,this.lutWidth=5,this.lutHeight=7,this.lutPadding=1,this.lutMin=0,this.lutMax=1,this.lutGamma=1,this.brightness=1,this.gamma=1,this.noise=0}}class C{constructor(t){this.settings=new $,n(this.settings,t),this.t=this.i(),this.s=this.o()}i(){const{charSet:t,fontFamily:n}=this.settings,i=[...t].filter((t=>{const n=e()({font:`1em ${t}`}),i=n.measureText(" ");return t=>n.measureText(t).width===i.width})(n)).map(r);return Int32Array.from(i)}o(){const{t,settings:n}=this,{lutMin:e,lutMax:i}=n,s=Array.from(t,t=>b.fromCharCode(t,n)),r=s.reduce((t,n)=>m(t,...n),0);for(const t of s)t.normalize(e*r,i*r);return s}render(t,n,e){return[...this.lines(t,v(n),v(e))].join("\n")}}const M=(t,n,e)=>{const i=`#version 300 es\n${e}`,s=t.createShader(n);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,35713))throw Error(`Shader error:\n${t.getShaderInfoLog(s)}\n${S(i)}\n`);return s},F=(t,n,e)=>{const i=t.createProgram();if(t.attachShader(i,n),t.attachShader(i,e),t.linkProgram(i),!t.getProgramParameter(i,35714))throw Error(`Program error: ${t.getProgramInfoLog(i)}`);return i},P=(t,n=3553)=>{const e=t.createTexture();return U(t,e,e=>t.bindTexture(n,e))},R=(t,n)=>e=>t.getUniformLocation(n,e),S=(t,n=1)=>t.replace(/^/gm,()=>`${n++}: `.padStart(5,"0")),U=(t,n,e)=>i=>(i&&(e(n),i(t,n),e(null)),n),A="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = 0.5 + 0.5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",G="#define MAP3(f, v) vec3(f(v.x), f(v.y), f(v.z))\n#define RGB(x) mix(x/12.92, pow((x+.055)/1.055, 2.4), step(.04045, x))\n#define LUM(x) dot(x, vec3(.2126, .7152, .0722))\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform float uBrightness;\nuniform float uGamma;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout vec4 vFragColor;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 0.1031);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec3 srgb = texture(uSrc, vPosition).rgb;\nfloat signal = uBrightness * pow(LUM(MAP3(RGB, srgb)), uGamma);\nfloat noise = uNoise * (hash13(vec3(gl_FragCoord.xy, 1000.*uRandom)) - 0.5);\nvFragColor = vec4(vec3(clamp(signal + noise, 0., 1.)), 0.);\n}\n",L="#define U ${ width }\n#define V ${ height }\n#define X ${ width * height }\n#define Y ${ chars }\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nuniform int uCharMap[Y];\nin vec2 vPosition;\nout vec4 vFragColor;\nstruct Result {\nint index;\nfloat value;\n};\nvoid main() {\nResult res = Result(0, float(X));\nivec2 pos = ivec2(vec2(textureSize(uSrc, 0))*vPosition) - ivec2(U, V)/2;\nfloat src[X];\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, pos + ivec2(u, v), 0).r;\nfor (int y = 0; y < Y; y++) {\nfloat value = 0.;\nfor (int x = 0; x < X; x++)\nvalue += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (res.value > value)\nres = Result(y, value);\n}\nvFragColor = vec4(uCharMap[res.index], 0, 0, 0);\n}\n",B=t=>{t.texParameteri(3553,10241,9728),t.texParameteri(3553,10240,9728)};t.CPURenderer=class extends C{*lines(t,n,i){const{settings:r,t:o,s:a}=this,{lutWidth:h,lutHeight:u,brightness:c,gamma:f,noise:d}=r,v=h*n,m=u*i,g=(t=>{if(t instanceof CanvasRenderingContext2D)return t;const{width:n,height:i}=t,s=e({width:n,height:i})();return s.drawImage(t,0,0),s})(w(t,v,m)).getImageData(0,0,v,m).data,x=new b(h,u);for(let t=0;m>t;t+=u){const n=[];for(let e=0;v>e;e+=h){let i=0,s=1/0;for(let n=0;u>n;n++)for(let s=0;h>s;s++){let r=e+s+(t+n)*v<<2;const o=c*(.2126*l(g[r++]/255)+.7152*l(g[r++]/255)+.0722*l(g[r++]/255))**f,a=d*(p()-.5);x[i++]=o+a}for(let t=a.length;t--;){const n=a[t].compare(x);s>n&&(s=n,i=t)}n.push(o[i])}yield s(...n)}}},t.GPURenderer=class extends C{constructor(t){super(t),this.h=((t,...n)=>{const e=i("canvas")().getContext("webgl2",t);if(!e)throw Error("WebGL2 is not available");for(const t of n)if(!e.getExtension(t))throw Error(`"${t}" extension is not available`);return e})({},"EXT_color_buffer_float"),this.u=((t,n=36160)=>{const e=t.createFramebuffer();return U(t,e,e=>t.bindFramebuffer(n,e))})(this.h)(),this.l=P(this.h)(B),this.v=P(this.h)(B),this.m=P(this.h)(B),this.p=b.combine(this.s),this.g=new Float32Array;const n=M(this.h,35633,A),e=M(this.h,35632,G),s=M(this.h,35632,((t,n={},e="$")=>Function(`{${Object.keys(n)}}`,e,`return \`${t}\``)(n,n))(L,{chars:this.t.length,width:this.settings.lutWidth,height:this.settings.lutHeight}));var r;this._=F(this.h,n,e),this.$=F(this.h,n,s),((t,n=34962)=>{const e=t.createBuffer();return U(t,e,e=>t.bindBuffer(n,e))})(this.h)((r=0,t=>{const n=Float32Array.of(1,1,-1,1,1,-1,-1,-1);t.bufferData(34962,n,35044),t.vertexAttribPointer(r,2,5126,!1,0,0),t.enableVertexAttribArray(r)}))}*lines(t,n,e){const{settings:i,t:r,p:o,h:a,_:h,$:u,u:c,l,v:f,m:d}=this,v=i.lutWidth*n,m=i.lutHeight*e,g=x(w(t,v,m)),_=R(a,h),y=R(a,u);this.g.length!==n*e<<2&&(this.g=new Float32Array(n*e<<2)),a.bindFramebuffer(36160,c),a.activeTexture(33986),a.bindTexture(3553,l),a.texImage2D(3553,0,33326,o.width,o.height,0,6403,5126,o),a.activeTexture(33985),a.bindTexture(3553,f),a.texImage2D(3553,0,6408,6408,5121,g),a.activeTexture(33984),a.bindTexture(3553,d),a.texImage2D(3553,0,33326,v,m,0,6403,5126,null),a.framebufferTexture2D(36160,36064,3553,d,0),a.useProgram(h),a.uniform1i(_("uSrc"),1),a.uniform1f(_("uBrightness"),i.brightness),a.uniform1f(_("uGamma"),i.gamma),a.uniform1f(_("uNoise"),i.noise),a.uniform1f(_("uRandom"),p()),a.viewport(0,0,v,m),a.drawArrays(5,0,4),a.activeTexture(33985),a.bindTexture(3553,d),a.activeTexture(33984),a.bindTexture(3553,f),a.texImage2D(3553,0,34836,v,m,0,6408,5126,null),a.framebufferTexture2D(36160,36064,3553,f,0),a.useProgram(u),a.uniform1i(y("uSrc"),1),a.uniform1i(y("uLUT"),2),a.uniform1iv(y("uCharMap"),r),a.viewport(0,0,n,e),a.drawArrays(5,0,4),a.readPixels(0,0,n,e,6408,5126,this.g),a.bindFramebuffer(36160,null);for(let t=0;e>t;t++){const e=[];for(let i=0;n>i;i++)e.push(this.g[i+t*n<<2]);yield s(...e)}}},t.LUT=b,t.Renderer=C,t.Settings=$,t.charSets=c,Object.defineProperty(t,"C",{value:!0})}));
//# sourceMappingURL=bundle.umd.min.js.map
