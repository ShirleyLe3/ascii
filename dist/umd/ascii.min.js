((t,n)=>{"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((t=t||self).ASCII={})})(this,function(t){"use strict";function*n(t=0,n=1/0,e=1){for(let i=t;n>i;i+=e)yield i}const e=Object.assign,i=t=>{const n=new Set;for(let e=t;e&&e!==Object.prototype;e=Object.getPrototypeOf(e))Object.getOwnPropertyNames(e).forEach(t=>n.add(t));return n},s=(...t)=>(...n)=>e(o("canvas")(...t).getContext("2d"),...n),o=t=>(...n)=>e(document.createElement(t),...n),r=String.fromCharCode,a=t=>t.charCodeAt(0),h=t=>{const n=s()({font:`1em ${t}`}),e=n.measureText(" ");return t=>n.measureText(t).width===e.width},c=r(...n(32,95),...n(96,127),...n(161,168),...n(174,178),169,171,172,180,181,183,187,191,215,247,...n(8216,8227),8249,8250,8729,8730,8734),u=c.replace(/[^\x00-\x7f]/g,""),l=c.replace(/[^\x00-\xff]/g,"");var f={ascii:u,extended:l,unicode:c};class d{constructor(){this.alphabet=u,this.quality="high",this.fontFace="monospace",this.fontWidth=40,this.fontHeight=70,this.fontBlur=9,this.fontGamma=1,this.lutWidth=5,this.lutHeight=7,this.lutPadding=1,this.lutGamma=1,this.brightness=1,this.gamma=1,this.noise=0}}const{abs:v,clz32:m,floor:g,max:p,random:x,round:y}=Math,b=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,w=t=>1<<p(0,31-m(t)),$="imageSmoothingQuality"in CanvasRenderingContext2D.prototype?(t,n,e)=>{const i=s({width:n,height:e})({imageSmoothingQuality:"medium"});return i.drawImage(t.canvas,0,0,n,e),i}:(t,n,e)=>{let i=w(t.canvas.width/n-1)*n,o=w(t.canvas.height/e-1)*e;const r=s({width:i,height:o})();r.drawImage(t.canvas,0,0,i,o);for(let t,s;s=o>e,(t=i>n)||s;)r.drawImage(r.canvas,0,0,i,o,0,0,i>>=+t,o>>=+s);const a=s({width:n,height:e})();return a.drawImage(r.canvas,0,0),a};class F extends Float32Array{constructor(t,n){super(t*n),this.width=t,this.height=n}static fromCharCode(t,n){const{fontWidth:e,fontHeight:i,fontFace:o,fontBlur:a,fontGamma:h}=n,{lutWidth:c,lutHeight:u,lutPadding:l,lutGamma:f}=n,d=2*l+c,v=2*l+u,m=y(d/c*e),g=y(v/u*i),p=s({width:m,height:g})(),x=r(t);p.fillStyle="#00f",p.fillRect(0,0,m,g),p.translate(m/2,g/2),p.fillStyle="#000",p.fillRect(-e/2,-i/2,e,i),p.translate(0,i/4),p.fillStyle="#fff",p.textAlign="center",p.font=`${i}px ${o}`;for(let t=0,n=1,e=1;a>t;[n,e]=[e,e+n])p.filter=`blur(${e}px)`,p.globalAlpha=(++t/a)**h,p.fillText(x,0,0);const w=$(p,d,v).getImageData(l,l,c,u).data,P=new F(c,u);for(let t=0;P.length>t;t++)P[t]=b(w[t<<2]/255)**f;return P}static combine(...t){const n=t[0].length,e=t.length,i=new F(n,e);for(let s=0;e>s;s++)i.set(t[s],s*n);return i}normalize(t,n){for(let e=0;this.length>e;e++)this[e]=(this[e]-t)/(n-t)}compare(t){let n=0;for(let e=this.length;e--;)n+=v(this[e]-t[e]);return n}}class P{constructor(t){this.settings=new d,e(this.settings,t),this.api=s()(),this.charMap=this.makeCharMap(),this.luts=this.makeLUTs()}makeCharMap(){const{alphabet:t,fontFace:n}=this.settings,e=[...t].filter(h(n)).map(a);return Uint16Array.from(e)}makeLUTs(){const{charMap:t,settings:n}=this,e=Array.from(t,t=>F.fromCharCode(t,n)),i=e.reduce((t,n)=>p(t,...n),0);for(const t of e)t.normalize(0,i);return e}resize(t,n,i){const{api:s,settings:o}=this;return e(s.canvas,{width:n,height:i}),s.imageSmoothingQuality=o.quality,s.drawImage(t,0,0,n,i),s}render(t,n,e){return[...this.lines(t,g(n),g(e))].join("\n")}}const S=5,U=5121,M=5126,A=6408,C=35632,R=35633,G=3553,L=33984,z=36160,_=36064,j=6403,B=33326,E=(t,...n)=>{const e=o("canvas")().getContext("webgl2",t);if(!e)throw Error("WebGL2 is not available");for(const t of n)if(!e.getExtension(t))throw Error(`"${t}" extension is not available`);return e},O=(t,n,e)=>{const i="#version 300 es\n"+e,s=t.createShader(n);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,35713))throw Error(`Shader error:\n${t.getShaderInfoLog(s)}\n${N(i)}\n`);return s},T=(t,n,e)=>{const i=t.createProgram();if(t.attachShader(i,n),t.attachShader(i,e),t.linkProgram(i),!t.getProgramParameter(i,35714))throw Error(`Program error: ${t.getProgramInfoLog(i)}`);return i},W=(t,n=34962)=>{const e=t.createBuffer();return V(t,e,e=>t.bindBuffer(n,e))},X=(t,n=G)=>{const e=t.createTexture();return V(t,e,e=>t.bindTexture(n,e))},D=(t,n=z)=>{const e=t.createFramebuffer();return V(t,e,e=>t.bindFramebuffer(n,e))},H=(t,n)=>e=>t.getUniformLocation(n,e),N=(t,n=1)=>t.replace(/^.*/gm,t=>((t,n)=>"0".repeat(p(0,t-n.length))+n)(5,`${n++}: `)+t),V=(t,n,e)=>i=>(i&&(e(n),i(t,n),e(null)),n),k=(t,n={},e="$")=>Function(`{${[...i(n)]}}`,e,`return \`${t}\``)(n,n),Q="in vec2 aPosition;\nout vec2 vPosition;\nvoid main() {\nvPosition = 0.5 + 0.5*aPosition;\ngl_Position = vec4(aPosition, 0., 1.);\n}\n",Y="#define MAP3(f, v) vec3(f(v.x), f(v.y), f(v.z))\n#define RGB(x) mix(x/12.92, pow((x+.055)/1.055, 2.4), step(.04045, x))\n#define LUM(x) dot(x, vec3(.2126, .7152, .0722))\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform float uBrightness;\nuniform float uGamma;\nuniform float uNoise;\nuniform float uRandom;\nin vec2 vPosition;\nout vec4 vFragColor;\nfloat hash13(vec3 p3) {\np3 = fract(p3 * 0.1031);\np3 += dot(p3, p3.yzx + 19.19);\nreturn fract((p3.x + p3.y) * p3.z);\n}\nvoid main() {\nvec3 srgb = texture(uSrc, vPosition).rgb;\nfloat signal = uBrightness * pow(LUM(MAP3(RGB, srgb)), uGamma);\nfloat noise = uNoise * (hash13(vec3(gl_FragCoord.xy, 1000.*uRandom)) - 0.5);\nvFragColor = vec4(vec3(clamp(signal + noise, 0., 1.)), 0.);\n}\n",q="#define U ${settings.lutWidth}\n#define V ${settings.lutHeight}\n#define X ${lut.width}\n#define Y ${lut.height}\nprecision mediump float;\nuniform sampler2D uSrc;\nuniform sampler2D uLUT;\nin vec2 vPosition;\nout vec4 vFragColor;\nstruct Result {\nint index;\nfloat value;\n};\nvoid main() {\nResult res = Result(0, float(X));\nivec2 pos = ivec2(vec2(textureSize(uSrc, 0))*vPosition) - ivec2(U, V)/2;\nfloat src[X];\nfor (int v = 0; v < V; v++)\nfor (int u = 0; u < U; u++)\nsrc[u + v*U] = texelFetch(uSrc, pos + ivec2(u, v), 0).r;\nfor (int y = 0; y < Y; y++) {\nfloat value = 0.;\nfor (int x = 0; x < X; x++)\nvalue += abs(src[x] - texelFetch(uLUT, ivec2(x, y), 0).r);\nif (res.value > value)\nres = Result(y, value);\n}\nvFragColor = vec4(res.index, 0, 0, 0);\n}\n",I=t=>{t.texParameteri(G,10241,9728),t.texParameteri(G,10240,9728)},J=t=>n=>{const e=Float32Array.of(1,1,-1,1,1,-1,-1,-1);n.bufferData(34962,e,35044),n.vertexAttribPointer(t,2,M,!1,0,0),n.enableVertexAttribArray(t)};t.HardwareRenderer=class extends P{constructor(t){super(t),this.gl=E({},"EXT_color_buffer_float"),this.fbo=D(this.gl)(),this.txLUT=X(this.gl)(I),this.txOdd=X(this.gl)(I),this.txEven=X(this.gl)(I),this.lut=F.combine(...this.luts),this.indices=new Float32Array;const n=O(this.gl,R,k(Q,this)),e=O(this.gl,C,k(Y,this)),i=O(this.gl,C,k(q,this));this.pass1=T(this.gl,n,e),this.pass2=T(this.gl,n,i),W(this.gl)(J(0))}*lines(t,n,e){const{settings:i,charMap:s,lut:o,gl:a,pass1:h,pass2:c,fbo:u,txLUT:l,txOdd:f,txEven:d}=this,v=i.lutWidth*n,m=i.lutHeight*e,g=this.resize(t,v,m).canvas,p=H(a,h),x=H(a,c);this.indices.length!==n*e&&(this.indices=new Float32Array(n*e)),a.bindFramebuffer(z,u),a.activeTexture(L+2),a.bindTexture(G,l),a.texImage2D(G,0,B,o.width,o.height,0,j,M,o),a.activeTexture(L+1),a.bindTexture(G,f),a.texImage2D(G,0,A,A,U,g),a.activeTexture(L+0),a.bindTexture(G,d),a.texImage2D(G,0,B,v,m,0,j,M,null),a.framebufferTexture2D(z,_,G,d,0),a.useProgram(h),a.uniform1i(p("uSrc"),1),a.uniform1f(p("uBrightness"),i.brightness),a.uniform1f(p("uGamma"),i.gamma),a.uniform1f(p("uNoise"),i.noise),a.uniform1f(p("uRandom"),Math.random()),a.viewport(0,0,v,m),a.drawArrays(S,0,4),a.activeTexture(L+1),a.bindTexture(G,d),a.activeTexture(L+0),a.bindTexture(G,f),a.texImage2D(G,0,B,v,m,0,j,M,null),a.framebufferTexture2D(z,_,G,f,0),a.useProgram(c),a.uniform1i(x("uSrc"),1),a.uniform1i(x("uLUT"),2),a.viewport(0,0,n,e),a.drawArrays(S,0,4),a.readPixels(0,0,n,e,j,M,this.indices),a.bindFramebuffer(z,null);for(let t=0;this.indices.length>t;){const e=this.indices.subarray(t,t+=n),i=Array.from(e,t=>s[t]);yield r(...i)}}},t.LUT=F,t.Renderer=P,t.Settings=d,t.SoftwareRenderer=class extends P{*lines(t,n,e){const{settings:i,charMap:s,luts:o}=this,{lutWidth:a,lutHeight:h,brightness:c,gamma:u,noise:l}=i,f=a*n,d=h*e,v=this.resize(t,f,d).getImageData(0,0,f,d).data,m=new Float32Array(a*h);for(let t=0;d>t;t+=h){const n=[];for(let e=0;f>e;e+=a){let i=0,r=1/0;for(let n=0;h>n;n++)for(let s=0;a>s;s++){let o=e+s+(t+n)*f<<2;const r=c*(.2126*b(v[o++]/255)+.7152*b(v[o++]/255)+.0722*b(v[o++]/255))**u,a=l*(x()-.5);m[i++]=r+a}for(let t=o.length;t--;){const n=o[t].compare(m);r>n&&(r=n,i=t)}n.push(s[i])}yield r(...n)}}},t.alphabets=f,Object.defineProperty(t,"t",{value:!0})});
//# sourceMappingURL=ascii.min.js.map
