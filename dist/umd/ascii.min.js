((t,e)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ASCII=e()})(this,function(){"use strict";const t=t=>t>.04045?((t+.055)/1.055)**2.4:t/12.92,{clz32:e,floor:i,max:s,round:n}=Math,r=function*(t,e,i=1){for(let s=t;e>s;s+=i)yield s},o=Object.assign,a=t=>e=>o(document.createElement(t),e),l=t=>a("canvas")(t).getContext("2d"),h=(t,e)=>((t,e="$")=>Function(e,"return `"+t+"`"))(t,"{"+Object.keys(e)+"}")(e);class u{constructor(t,e){this.regl=t,this.binds=e}compile(t){const{regl:e,binds:i}=this,{vert:s,frag:n}=i;this.command=e({...i,...s&&{vert:h(s,t)},...n&&{frag:h(n,t)}})}}const c="attribute vec2 aPosition;varying vec2 vPosition;void main(){vPosition=0.5+(0.5*aPosition);gl_Position=vec4(aPosition,0.,1.);}";class d extends u{constructor(t){super(t,{vert:c,depth:{enable:!1},attributes:{aPosition:[1,1,-1,1,1,-1,-1,-1]},primitive:"triangle strip",count:4})}}const f="#define MAP3(f,v) vec3(f(v.x),f(v.y),f(v.z))\n#define RGB(x) mix(x/12.92,pow((x+.055)/1.055,2.4),step(.04045,x))\n#define LUM(x) dot(x,vec3(.212655,.715158,.072187))\nprecision mediump float;uniform sampler2D uSrc;uniform float uBrightness;uniform float uGamma;uniform float uNoise;uniform float uTime;varying vec2 vPosition;float hash13(vec3 p3){p3=fract(p3*0.1031);p3+=dot(p3,p3.yzx+19.19);return fract((p3.x+p3.y)*p3.z);}void main(){vec3 srgb=texture2D(uSrc,vPosition).rgb;float signal=uBrightness*pow(LUM(MAP3(RGB,srgb)),uGamma);float noise=uNoise*(hash13(vec3(gl_FragCoord.xy,uTime))-0.5);gl_FragColor=vec4(signal+noise,0.,0.,0.);}";class g extends u{constructor(t){super(t,{frag:f,framebuffer:t.prop("dst"),uniforms:{uSrc:t.prop("src"),uBrightness:t.prop("brightness"),uGamma:t.prop("gamma"),uNoise:t.prop("noise"),uTime:t.context("time")}})}}const m="#define TEX(s,size,uv,xy) texture2D(s,(uv)+(xy)/(size))\n#define O ${settings.optimized ? 1 : 0}\n#define U ${settings.lutWidth}\n#define V ${settings.lutHeight}\n#define X ${luts[0].length}\n#define Y ${luts.length}\nprecision mediump float;uniform sampler2D uSrc;uniform sampler2D uLut;uniform vec2 uSrcSize;uniform vec2 uLutSize;varying vec2 vPosition;const vec2 srcOffset=0.5*(0.5-vec2(U,V));const vec2 lutOffset=vec2(0.5);void main(){float bestDelta=float(X);int bestChar=0;\n#if O\nfloat src[X];for(int v=0;v<V;v++)for(int u=0;u<U;u++)src[u+(v*U)]=TEX(uSrc,uSrcSize,vPosition,srcOffset+vec2(u,v)).r;for(int y=0;y<Y;y++){float delta=0.;for(int x=0;x<X;x++)delta+=abs(src[x]-TEX(uLut,uLutSize,0.,lutOffset+vec2(x,y)).r);if(delta<bestDelta){bestDelta=delta;bestChar=y;}}\n#else\nfor(int y=0;y<Y;y++){int x=0;float delta=0.;for(int v=0;v<V;v++)for(int u=0;u<U;u++)delta+=abs(TEX(uSrc,uSrcSize,vPosition,srcOffset+vec2(u,v)).r-TEX(uLut,uLutSize,0.,lutOffset+vec2(x++,y)).r);if(delta<bestDelta){bestDelta=delta;bestChar=y;}}\n#endif\ngl_FragColor=vec4(bestChar,0,0,0);}";class p extends u{constructor(t){super(t,{frag:m,framebuffer:t.prop("dst"),context:{src:t.prop("src"),lut:t.prop("lut")},uniforms:{uSrc:t.context("src"),uLut:t.context("lut"),uSrcSize:({src:t})=>[t.width,t.height],uLutSize:({lut:t})=>[t.width,t.height]}})}}class v{constructor(t){this.ascii=t,this.context=l(),this.canvas=this.context.canvas,this.rgba=new Float32Array(1);const{regl:e}=t;this.src=e.texture(),this.lut=e.texture(),this.fbo1=e.framebuffer({depthStencil:!1,colorType:"float"}),this.fbo2=e.framebuffer({depthStencil:!1,colorType:"float"}),this.setup=new d(e),this.pass1=new g(e),this.pass2=new p(e)}resize(t,e,i){const{context:s,canvas:n,ascii:{settings:{quality:r}}}=this;return"low"===r?t:(n.width===e&&n.height===i||(o(n,{width:e,height:i}),s.imageSmoothingQuality=r),s.drawImage(t,0,0,e,i),n)}update(){const{ascii:t}=this;this.lut({format:"alpha",type:"float",data:t.luts}),this.setup.compile(t),this.pass1.compile(t),this.pass2.compile(t)}render(t,e,i){const{src:s,lut:n,fbo1:r,fbo2:o,ascii:{regl:a,settings:l}}=this,{brightness:h,gamma:u,noise:c}=l,d=l.lutWidth*e,f=l.lutHeight*i,g=e*i<<2;return this.rgba.length!==g&&(this.rgba=new Float32Array(g)),s(this.resize(t,d,f)),r.resize(d,f),o.resize(e,i),a.poll(),this.setup.command(()=>{this.pass1.command({dst:r,src:s,brightness:h,gamma:u,noise:c}),this.pass2.command({dst:o,src:r,lut:n},()=>{a.draw(),a.read(this.rgba)})}),this.rgba}}class y{constructor(){this.optimized=!0,this.quality="high",this.fontFace="monospace",this.fontWidth=40,this.fontHeight=70,this.fontBlur=6,this.lutWidth=5,this.lutHeight=7,this.lutPadding=1,this.brightness=1,this.gamma=1,this.noise=0}}class x extends y{get lutWidthPadded(){return 2*this.lutPadding+this.lutWidth}get lutHeightPadded(){return 2*this.lutPadding+this.lutHeight}get lutWidthRatio(){return this.lutWidthPadded/this.lutWidth}get lutHeightRatio(){return this.lutHeightPadded/this.lutHeight}get fontWidthPadded(){return n(this.lutWidthRatio*this.fontWidth)}get fontHeightPadded(){return n(this.lutHeightRatio*this.fontHeight)}}const b=t=>1<<s(0,31-e(t)),S="imageSmoothingQuality"in CanvasRenderingContext2D.prototype?(t,e,i)=>{const s=l({width:e,height:i});return s.imageSmoothingQuality="medium",s.drawImage(t.canvas,0,0,e,i),s}:(t,e,i)=>{let s=b(t.canvas.width/e-1)*e,n=b(t.canvas.height/i-1)*i;const r=l({width:s,height:n});r.drawImage(t.canvas,0,0,s,n);for(let t,o;(t=s>e)||(o=n>i);)r.drawImage(r.canvas,0,0,s,n,0,0,s>>=t,n>>=o);const o=l({width:e,height:i});return o.drawImage(r.canvas,0,0),o},w=function*(){yield*r(32,95),yield*r(96,127),yield*r(161,168),yield*r(174,178),yield*[169,171,172,180,181,183,187,191,215,247],yield*r(8216,8227),yield*[8249,8250,8729,8730,8734]};return class{constructor(t,e){this.settings=new x,this.charMap=new Uint16Array(this.filter(w()));const i=a("canvas")();this.regl=t({canvas:i,extensions:["OES_texture_float"]}),this.renderer=new v(this),this.update(e)}makeGlyph(t){const{fontFace:e,fontBlur:i,fontWidth:s,fontHeight:n,fontWidthPadded:r,fontHeightPadded:o}=this.settings,a=l({width:r,height:o}),h=String.fromCharCode(t);a.fillStyle="#00f",a.fillRect(0,0,r,o),a.fillStyle="#000",a.translate(r/2,o/2),a.fillRect(-s/2,-n/2,s,n),a.fillStyle="#fff",a.textAlign="center",a.font=`${n}px ${e}`,a.translate(0,n/4);for(let t=0;i>t;)a.filter=`blur(${1<<t}px)`,a.globalAlpha=++t/i,a.fillText(h,0,0);return a}makeLut(t){const{lutWidth:e,lutHeight:i,lutPadding:s,lutWidthPadded:n,lutHeightPadded:r}=this.settings,o=S(this.makeGlyph(t),n,r).getImageData(s,s,e,i).data,a=new Float32Array(o.length>>2);for(let t=0;a.length>t;t++)a[t]=o[t<<2]/255;return a}makeLuts(){const e=Array.from(this.charMap,t=>this.makeLut(t)),i=e.reduce((t,e)=>s(t,...e),0);for(const s of e)for(let e=0;s.length>e;e++)s[e]=t(s[e]/i);return e}*filter(t){const e=l();e.font=`1em ${this.settings.fontFace}`;const i=e.measureText(" ");for(const s of t)e.measureText(String.fromCharCode(s)).width===i.width&&(yield s)}*map(t,e,i){const{charMap:s}=this;for(let n=0;i>n;n++){for(let i=0;e>i;i++)yield s[t[i+n*e<<2]];yield 10}}update(t){o(this.settings,t),this.luts=this.makeLuts(),this.renderer.update()}render(t,e,s){const n=i(e),r=i(s),o=this.renderer.render(t,n,r);return String.fromCharCode(...this.map(o,n,r))}}});
//# sourceMappingURL=ascii.min.js.map
