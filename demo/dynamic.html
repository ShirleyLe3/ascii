<!DOCTYPE html>
<meta name='viewport' content='width=device-width,user-scalable=no'>
<style>
  html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
  body { background: black; color: white; }
</style>
<script type='module'>
  import { fetchImage, update } from './lib/util.js'
  import { ReactDOM, html } from './lib/dom.js'
  import { Demo } from './lib/components/Demo.js'
  import { GPURenderer } from '../dist/bundle.esm.js'

  const dynamicCrop = async url => {
    const canvas = document.createElement('canvas')
    const context = canvas.getContext('2d')

    const image = await fetchImage({ src: url })
    const { width: iw, height: ih } = image
    const p = Math.round(Math.min(iw, ih)/36) // padding
    const iwʹ = iw - 2*p // cropped image width
    const ihʹ = ih - 2*p // cropped image height
    const irʹ = iwʹ/ihʹ // cropped image ratio

    return (r, t) => {
      const w = r > irʹ ? iwʹ : Math.round(ihʹ*r)
      const h = r > irʹ ? Math.round(iwʹ/r) : ihʹ
      const x = (w - iw)/2 + p*Math.cos(Math.PI*t/3e3)
      const y = (h - ih)/2 + p*Math.sin(Math.PI*t/5e3)
      update(canvas, { width: w, height: h })
      context.drawImage(image, x, y)
      return canvas
    }
  }

  const renderer = async demo => {
    const { fontFamily } = getComputedStyle(demo.root.current)
    const ascii = new GPURenderer({ fontFamily })
    const frame = await dynamicCrop('assets/image.jpg')
    return (w, h, r, t) => ascii.render(frame(r, t), w, h)
  }

  ReactDOM.render(html`<${Demo} ...${{ renderer }} />`, document.body)
</script>
